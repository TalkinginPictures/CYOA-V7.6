<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Adventure Builder</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #6dd5fa, #ffffff);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    #app {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      max-width: 800px;
      width: 90%;
      padding: 20px;
      text-align: center;
    }
    h1, h2 {
      margin-bottom: 10px;
    }
    .options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }
    .option {
      border: 2px solid #ccc;
      border-radius: 12px;
      padding: 10px;
      cursor: pointer;
      background: #f9f9f9;
      transition: transform 0.2s, background 0.2s;
    }
    .option:hover {
      background: #e3f2fd;
      transform: scale(1.05);
    }
    .option img {
      max-width: 100%;
      height: 100px;
      object-fit: contain;
    }
    #restartBtn, #savePdfBtn {
      margin-top: 15px;
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      background: #2196F3;
      color: white;
      cursor: pointer;
      font-size: 1rem;
      margin-right: 10px;
    }
    #savePdfBtn {
      background: #4CAF50;
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>Loading...</h1>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const { jsPDF } = window.jspdf;
    const app = document.getElementById("app");

    let studentName = "";
    let answers = [];

    const questions = [
      {
        text: "What will you wear on your adventure?",
        options: ["Knight Armour","Pirate Outfit","Wizard Robe","Ninja Suit","Space Suit","Explorer Gear","Royal Clothes","Superhero Costume","Pajamas"]
      },
      {
        text: "Who will be your trusty companion?",
        options: ["Loyal Dog","Mischievous Cat","Fierce Dragon","Wise Owl","Cheeky Monkey","Brave Horse","Helpful Robot","Magical Unicorn","Giant Snail"]
      },
      {
        text: "What weapon or tool will you take?",
        options: ["Magic Wand","Sword","Bow & Arrow","Shield","Laser Blaster","Slingshot","Net","Spell Book","Frying Pan"]
      },
      {
        text: "What music will play on your adventure?",
        options: ["K-Pop","Hip Hop","R&B","Pop","Rock","Reggae","Afrobeat","Classical","Country"]
      },
      {
        text: "Who will be your main enemy?",
        options: ["Evil Wizard","Sneaky Thief","Ferocious Dragon","Giant Troll","Alien Overlord","Angry Pirate","Mad Scientist","Mischievous Ghost","Evil Twin"]
      },
      {
        text: "Where will your adventure take place?",
        options: ["Haunted Castle","Deep Space","Dark Forest","Desert Wasteland","Underwater City","Volcano","Snowy Mountain","Secret Lab","Candy Land"]
      },
      {
        text: "What great challenge must you overcome?",
        options: ["Solve a Riddle","Cross a Raging River","Escape a Trap","Defeat a Monster","Sneak Past Guards","Build a Raft","Win a Dance Battle","Cook a Magical Feast","Race to the Finish"]
      },
      {
        text: "What is your reward at the end?",
        options: ["Treasure Chest","Golden Crown","Legendary Sword","Magic Potion","A Wish Granted","Party with Friends","Flying Pet","Your Own Castle","Eternal Glory"]
      }
    ];

    let currentQuestion = -1;

    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utterance);
    }

    function startGame() {
      app.innerHTML = `
        <h1>Welcome, adventurer!</h1>
        <p>What is your name?</p>
        <input id="nameInput" placeholder="Type your name" />
        <button onclick="setName()">Start Adventure</button>
      `;
    }

    function setName() {
      studentName = document.getElementById("nameInput").value || "Adventurer";
      answers = [];
      currentQuestion = -1;
      nextQuestion();
    }

    async function nextQuestion() {
      currentQuestion++;
      if (currentQuestion >= questions.length) {
        showSummary();
        return;
      }

      const q = questions[currentQuestion];
      app.innerHTML = `<h2>${q.text}</h2><div class="options">Loading...</div>`;
      speak(`${studentName}, ${q.text}`);

      const container = app.querySelector(".options");
      container.innerHTML = "";
      for (const option of q.options) {
        const imgUrl = await fetchImage(option);
        const div = document.createElement("div");
        div.className = "option";
        div.innerHTML = `<img src="${imgUrl}" alt="${option}"><p>${option}</p>`;
        div.onclick = () => selectOption(option, imgUrl);
        container.appendChild(div);
      }
    }

    async function fetchImage(query) {
      try {
        const ara = await fetch(`https://api.arasaac.org/api/pictograms/en/search/${encodeURIComponent(query)}`);
        const araData = await ara.json();
        if (araData.length > 0) {
          return `https://static.arasaac.org/pictograms/${araData[0]._id}/${araData[0]._id}_500.png`;
        }
      } catch {}
      const pixabayKey = "49978957-7f3f3c500656460c1f5b4026f";
      const pix = await fetch(`https://pixabay.com/api/?key=${pixabayKey}&q=${encodeURIComponent(query)}&image_type=illustration&per_page=3`);
      const pixData = await pix.json();
      if (pixData.hits.length > 0) return pixData.hits[0].webformatURL;
      return "https://via.placeholder.com/150?text=" + encodeURIComponent(query);
    }

    function selectOption(option, imgUrl) {
      answers.push({question: questions[currentQuestion].text, option, imgUrl});
      const affirmations = [
        "Great choice!",
        "Awesome pick!",
        "Nice one!",
        "Brilliant!",
        "Fantastic choice!",
        "Well done!",
        "This adventure is getting exciting!",
        "Excellent selection!"
      ];
      const randomAffirmation = affirmations[Math.floor(Math.random() * affirmations.length)];
      speak(`${studentName}, you chose ${option}. ${randomAffirmation}`);
      setTimeout(nextQuestion, 1200);
    }

    function showSummary() {
      let html = `<h2>${studentName}'s Adventure Story</h2>`;
      let story = `${studentName}, here's your adventure: `;
      html += `<div class="options">`;
      for (const ans of answers) {
        story += `You chose to ${ans.question.toLowerCase()} ${ans.option}. `;
        html += `<div class="option"><img src="${ans.imgUrl}" alt="${ans.option}"><p>${ans.option}</p></div>`;
      }
      html += `</div><br>`;
      html += `<button id="restartBtn" onclick="startGame()">Create Another Adventure</button>`;
      html += `<button id="savePdfBtn" onclick="savePDF()">Save Story as PDF</button>`;
      app.innerHTML = html;
      speak(story);
    }

    async function savePDF() {
      const doc = new jsPDF();
      let y = 20;
      doc.setFontSize(16);
      doc.text(`${studentName}'s Adventure`, 10, y);
      y += 10;
      for (const ans of answers) {
        doc.setFontSize(12);
        doc.text(`${ans.question}: ${ans.option}`, 10, y);
        y += 8;
        const img = await toDataURL(ans.imgUrl);
        doc.addImage(img, "JPEG", 10, y, 30, 30);
        y += 35;
        if (y > 270) { doc.addPage(); y = 20; }
      }
      doc.save(`${studentName}_adventure.pdf`);
    }

    async function toDataURL(url) {
      const res = await fetch(url);
      const blob = await res.blob();
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    }

    startGame();
  </script>
</body>
</html>
